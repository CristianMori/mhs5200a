#!/bin/bash
# I expect to find my .dat and .awk files in the same directory I am in!
if [ -z "$1" -o "$1" == "--help" -o "$1" == "-h" ]
then
cat <<EOF
setwave5200 by Al Williams al.williams@awce.com
Public Domain -- use it how you like
Source: https://github.com/wd5gnr/mhs5200a

Usage:
setwave5200 port csvfile memory [csvfile memory ....]

Example:

setwave5200 /dev/ttyUSB0 sine.csv 0 cos.csv 1 noise.csv 15

EOF
exit 1
fi
PORT="$1"
stty -F "$PORT" 57600 ignbrk -brkint -icrnl -imaxbel -opost -onlcr -isig -icanon -iexten -echo -echoe -echok -echoctl -echoke min 60 time 1
shift
while [ ! -z "$2" ]
do
  if awk -vchan="$2" -f "$0.awk" "$1" "$0.dat" >/tmp/wave$$
  then
     while read -r line 
     do
        echo -n . 
        echo "$line" >"$PORT"
	sleep 1
     done </tmp/wave$$
     echo "$1 done"
  else
    echo "$1 failed"
  fi
  shift
  shift
done
exit 0

